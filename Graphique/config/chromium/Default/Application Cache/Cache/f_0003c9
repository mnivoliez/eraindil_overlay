
if(typeof(limitation)=="undefined"){var limitation={chan:null,uniqid:0,init:function(){if(USER.USER_ID===0){return false;}
limitation.uniqid=new Date().getTime();limitation.chan=USER.USER_ID+'_'+USER.USER_ID+'_STREAM';live.addInternalChannel(limitation.chan);Events.subscribe(Events.player.play,function(evt,params){if(typeof(params.value)=='undefined'){return false;}
limitation.sendAction('PLAY',params.value.SNG_ID);});Events.subscribe(Events.player.resume,function(evt,params){if(typeof(params.value)=='undefined'){return false;}
limitation.sendAction('PLAY',params.value.SNG_ID);});Events.subscribe(Events.live.limitation,function(evt,params){limitation.execAction(params);});return true;},reset:function(){limitation.chan=null;limitation.uniqid=0;return true;},sendAction:function(action,value){if(USER.USER_ID===0){return false;}
if(action!='PLAY'){return false;}
var param={APP:'LIMITATION',ACTION:action,VALUE:{USER_ID:USER.USER_ID,UNIQID:limitation.uniqid,SNG_ID:value}};live.publish(limitation.chan,param);return true;},execAction:function(message){if(typeof(message)!='object'||countObject(message)!=2){return false;}
var data=message[0];var time=message[1];if(data.VALUE.USER_ID===0){return false;}
if(data.VALUE.USER_ID==USER.USER_ID&&data.VALUE.UNIQID==limitation.uniqid){return false;}
if((live.server_timestamp-time)>5){return false;}
if(data.ACTION!='PLAY'){return false;}
if(dzPlayer.isPlaying()===false||dzPlayer.getPlayerType()!='mod'){return false;}
Events.trigger(Events.live.simultaneousAccess,{});playercontrol.doAction('pause');modal.open('/lightbox/limitation.php');return true;}};};
if(typeof(live)=='undefined'){var live={channels:[],connected:false,ticker_nb:0,server_timestamp:0,online_count:0,lastFeed:'',init:function(){Events.ready(Events.user.loaded,function(){live.connect();});return true;},connect:function(){if(XHR===true||Modernizr.websockets===false){live.publish=xhr_polling.publish;live.subscribe=xhr_polling.subscribe;live.unsubscribe=xhr_polling.subscribe;live.close=xhr_polling.close;xhr_polling.init();return true;}
live.socket=new WebSocket(PROTOCOL_WS+SETTING_HOST_LIVE+'/ws/'+getCookie('sid'));live.socket.onopen=function(){live.connected=true;live.transport='websocket';for(var channel in live.channels){live.subscribe(channel);}};live.socket.onclose=function(){live.connected=false;};live.socket.onmessage=function(evt){live.onMsg(evt.data);};live.socket.onerror=function(evt){};return true;},disconnect:function(){if(!live.connected){return true;}
live.channels=[];live.connected=false;live.close();return true;},close:function(){live.socket.close();},addChannel:function(channel){if(typeof(channel)=='undefined'||channel===''){return false;}
live.addInternalChannel(channel);live.subscribe(channel);return true;},addInternalChannel:function(channel){if(typeof(channel)=='undefined'||channel===''){return false;}
live.channels[channel]=true;return true;},deleteChannel:function(channel){if(typeof(channel)=='undefined'||channel===''){return false;}
if(typeof(live.channels[channel])=='undefined'){return false;}
delete live.channels[channel];if(live.transport=='websocket'){live.unsubscribe(channel);}
return true;},subscribe:function(channel){if(!live.connected){return false;}
if(USER.USER_ID===0){return false;}
live.socket.send(JSON.stringify(['sub',channel]));return true;},unsubscribe:function(channel){if(!live.connected){return false;}
if(USER.USER_ID===0){return false;}
live.socket.send(JSON.stringify(['unsub',channel]));return true;},publish:function(channel,data){if(!live.connected){return false;}
if(USER.USER_ID===0){return false;}
live.socket.send(JSON.stringify(['send',channel,data]));return true;},onMsg:function(data){try{if(typeof(data)=='undefined'||data.length===0){return false;}
data=JSON.parse(data);if(data[0]!=='msg'){return false;}
live.dispatch([data[2],0]);return true;}catch(e){console.log(e);}},dispatch:function(message){try{if(typeof(message)=='undefined'||message===''){return false;}
if(message.length===0||typeof(message[0].APP)=='undefined'){return false;}
var app=message[0].APP.toLowerCase();if(typeof(Events.live[app])==='undefined'){return false;}
Events.trigger(Events.live[app],message);return true;}catch(e){console.log(e.message,e.stack);}}};};
if(typeof(friends)=="undefined"){var friends={loaded:false,drawn:false,displayed:false,load:function(){if(friends.drawn===false){friends.createList();}
friends.loaded=true;friends.show();return true;},show:function(){livebar.tab='friends';livebar.show();$('.search_filter',livebar.$livebar_content).show();friends.initSearch();notifications.hide();ticker.hide();if(!friends.loaded){friends.load();return;}
friends.messageRefreshNew();$('#friends').show();$('#btn_friends .tabs-friends span').addClass('active');Events.trigger(Events.user.settingChange,{site:{livebar_tab:livebar.tab,livebar_state:'open'}});friends.displayed=true;livebar.$livebar_content.tinyscrollbar_update('relative');return true;},hide:function(){$('#friends').hide();$('.search_filter',livebar.$livebar_content).hide();$('#btn_friends .tabs-friends span').removeClass('active');friends.displayed=false;return true;},createList:function(){try{if(typeof(userData.data.FRIENDS)=='undefined'){return false;}
friends.drawn=true;var display_line_online=[];var display_line_offline=[];var display_line_message=[];var j=0;var k=0;var l=0;var len=userData.data.FRIENDS.count;for(var i=0;i<len;i++){if(typeof(userData.data.FRIENDS.data[i])=='undefined'){continue;}
if(typeof(userData.data.MESSAGE_UNREAD_HASH[userData.data.FRIENDS.data[i].USER_ID])!='undefined'){display_line_message[l]=friends.build(userData.data.FRIENDS.data[i],true);l+=1;}else if(userData.data.FRIENDS.data[i].TIMER===0){display_line_offline[k]=friends.build(userData.data.FRIENDS.data[i],(k<30));k+=1;}else{display_line_online[j]=friends.build(userData.data.FRIENDS.data[i],true);j+=1;}}
$('#onlinePane').html(display_line_online.join(''));$('#offlinePane').html(display_line_offline.join(''));$('#messagePane').html(display_line_message.join(''));$('.online_friend',livebar.$livebar_content).mouseenter(function(){friends.userOver($(this));}).mouseleave(function(){friends.userOut($(this));});$('.online_friend[data-hovercard^="/ajax"]',$('#onlinePane')).mouseenter(function(){hovercard.init($(this),500,true,'e');}).mouseleave(function(){hovercard.remove();});friends.online_count=j;friends.lastScrollPosition=0;friends.lastLine=0;return true;}catch(e){console.log(e);}},build:function(data,visible){var profile_link="if ($('.message:visible', $(this)).length == 1) { modal.open('lightbox/instant_messenger.php?friend_id="+data.USER_ID+"'); friends.changeState("+data.USER_ID+", 'offline'); } else { loadBox('profile/"+data.USER_ID+"'); }; return false;";$item=livebar.$modele_friend.clone();$item.attr({'id':'o_f_'+data.USER_ID,'friend_id':data.USER_ID}).attr('onClick',profile_link).hide();$('.pseudo',$item).text(data.DISPLAY_NAME);if(typeof(userData.data.MESSAGE_UNREAD_HASH[data.USER_ID])!='undefined'){$('.message',$item).show();}else if(data.SONG!==false){var hovercard_link='/ajax/hovercard/page.php?card=ticker&action=listen&type=song&user_id='+data.USER_ID+'&id='+data.SONG.SNG_ID;if(typeof(data.SONG.CONTEXT)!='undefined'&&typeof(data.SONG.CONTEXT.ID)!='undefined'&&typeof(data.SONG.CONTEXT.TYPE)!='undefined'){hovercard_link+='&context_id='+data.SONG.CONTEXT.ID+'&context_type='+data.SONG.CONTEXT.TYPE;}
$item.attr('data-hovercard',hovercard_link);$('.listen',$item).html('<a id="hc_follow_'+data.USER_ID+'" class="icn_onair sprite_live"></a>');$('.online',$item).hide();}
var user_picture=SETTING_DOMAIN_IMG+'/user/'+data.USER_PICTURE+'/25x25-000000-80-0-0.jpg';if(visible){$('#picture',$item).html('<img src="'+user_picture+'" height="25" width="25">');$item.show();}else{$item.attr('data-picture',user_picture);}
return util.getOuterHTML($item);},removeFriend:function(id){$('#o_f_'+id).remove();return true;},lazyLoad:function(from,to){try{var line=Math.ceil(to/33)+Math.ceil(livebar.scrollHeight/33)+10;if(line>friends.lastLine){$("#offlinePane .online_friend").slice($("#offlinePane img").length,line).each(function(){$('#picture',this).html('<img src="'+$(this).attr('data-picture')+'">');$(this).show();});friends.lastLine=line;livebar.$livebar_content.tinyscrollbar_update('relative');}
return true;}catch(e){console.log(e.message,e.stack);}},userOver:function(user){try{selected_friend=user.attr('friend_id');if(livebar.$livebar_content.hasClass('drophover')){user.addClass('friend-share');}
return;}catch(e){console.log(e.message,e.stack);}},userOut:function(user){try{if(livebar.$livebar_content.hasClass('drophover')){user.removeClass('friend-share');}
return;}catch(e){console.log(e.message,e.stack);}},filter:function(){try{$('#onlinePane',livebar.$livebar_content).hide();$('#offlinePane',livebar.$livebar_content).hide();$('#searchDeezerPane',livebar.$livebar_content).hide();var query=$("#filter_input").val().toLowerCase();if(query===''){$('#livebar .search-friends').removeClass('hide_background');$('#livebar_content .search_filter .cross').hide();$('#onlinePane',livebar.$livebar_content).show();$('#offlinePane',livebar.$livebar_content).show();$('#searchPane',livebar.$livebar_content).hide();livebar.$livebar_content.tinyscrollbar_update('relative');return false;}else{$('#livebar .search-friends').addClass('hide_background');$('#livebar_content .search_filter .cross').show();}
var len=userData.data.FRIENDS.count;var display_line=[];var j=0;for(var i=0;i<len;i++){if(typeof(userData.data.FRIENDS.data[i])=='undefined'){continue;}
var name=userData.data.FRIENDS.data[i].DISPLAY_NAME.toLowerCase();if(name.indexOf(query)!=-1){$item=$('#o_f_'+userData.data.FRIENDS.data[i].USER_ID).clone();$item.show();display_line[j]=util.getOuterHTML($item);j+=1;}}
$('#searchPane',livebar.$livebar_content).html(display_line.join('')).show();$('.online_friend[data-hovercard^="/ajax"]',$('#searchPane')).mouseenter(function(){hovercard.init($(this),500,true,'e');}).mouseleave(function(){hovercard.remove();});$("#searchPane #picture").each(function(){if($('img',$(this)).length===0){$(this).html('<img src="'+$(this).parent().attr('data-picture')+'">');}});livebar.$livebar_content.tinyscrollbar_update('relative');if(j<10){$('#more',livebar.$livebar_content).show();}else{$('#more',livebar.$livebar_content).hide();}
return true;}catch(e){console.log(e.message,e.stack);}},searchUser:function(){try{var query=$("#filter_input").val();if(query.length<3){return false;}
$('#more',livebar.$livebar_content).hide();api.call('search_user.search',{data:[query]},function(req){if(req.error.length!==0){return;}
if(req.results.data.length===0){$('#searchDeezerPane').text(sprintf(trad.live.text_no_result,query)).show();return;}
var display_line=[];for(var i=0;i<req.results.data.length;i++){var user=req.results.data[i];var profile_link='loadBox(\'profile/'+user.USER_ID+'\'); return false;';$item=livebar.$modele_friend.clone().show();$('.pseudo',$item).text(user.BLOG_NAME).attr('onClick',profile_link);var user_picture=SETTING_DOMAIN_IMG+'/user/'+user.USER_PICTURE+'/25x25-000000-80-0-0.jpg';$('#picture',$item).html('<img src="'+user_picture+'">').attr('onClick',profile_link);display_line[i]=util.getOuterHTML($item);}
$('#searchDeezerPane').html(display_line.join('')).show();livebar.$livebar_content.tinyscrollbar_update('relative');});return true;}catch(e){console.log(e.message,e.stack);}},updateOnline:function(){try{if(USER.USER_ID===0){return false;}
if(typeof(userData.data.FRIENDS)=='undefined'){return false;}
var len=(typeof(userData.data.FRIENDS.count)!='undefined')?userData.data.FRIENDS.count:0;for(var i=0;i<len;i++){if(typeof(userData.data.FRIENDS.data[i])=='undefined'){continue;}
if(typeof(userData.data.FRIENDS.data[i].TIMER)=='undefined'){continue;}
if(userData.data.FRIENDS.data[i].TIMER>0){userData.data.FRIENDS.data[i].TIMER-=10;if(userData.data.FRIENDS.data[i].TIMER<=0){userData.data.FRIENDS.data[i].TIMER=0;userData.data.FRIENDS.data[i].SONG=false;friends.online_count-=1;if(friends.drawn===true){friends.changeState(userData.data.FRIENDS.data[i].USER_ID,"offline");}}}}
return true;}catch(e){console.log(e.message,e.stack);}},changeState:function(friend_id,state){try{$friend=$('#o_f_'+friend_id);$friend.detach().prependTo('#'+state+'Pane').show().unbind('click');if(state=="offline"){$('.listen',$friend).empty();$('.online',$friend).show();$('.message',$friend).hide();$friend.attr('data-hovercard',null);}else if(state=="message"){if($('img',$friend).length===0){$("#picture",$friend).html('<img src="'+$friend.attr('data-picture')+'">');}
$('.message',$friend).show();$('.listen',$friend).empty();$friend.attr('data-hovercard',null);}else{if($('img',$friend).length===0){$("#picture",$friend).html('<img src="'+$friend.attr('data-picture')+'">');}
$('.message',$friend).hide();if(userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[friend_id]].SONG!==false){var hovercard_link='/ajax/hovercard/page.php?card=ticker&action=listen&type=song&user_id='+friend_id+'&id='+userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[friend_id]].SONG.SNG_ID;$friend.attr('data-hovercard',hovercard_link);$('.listen',$friend).html('<a id="hc_follow_'+friend_id+'" class="icn_onair sprite_live"></a>');$('.online',$friend).hide();$friend.mouseenter(function(){hovercard.init($(this),500,true,'e');}).mouseleave(function(){hovercard.remove();});}else{$('.listen',$friend).empty();$('.online',$friend).show();$friend.attr('data-hovercard',null);}}
friends.messageRefreshNew();return true;}catch(e){console.log(e);}},initSearch:function(){$('#livebar_content .search_filter .cross').unbind('click').click(function(){$('#livebar_content .search_filter .cross').hide();$('#livebar .search-friends').removeClass('hide_background');$('#filter_input').val('');$('#filter_input').focus();$(this).hide();friends.filter();}).hide();$('#filter_input').unbind('keyup').keyup(function(e){if(e.keyCode==13){e.stopPropagation();friends.searchUser();}});if(''!==$('#filter_input').val()){$('#livebar .search-friends').addClass('hide_background');$('#livebar_content .search_filter .cross').show();}
$('.search_filter').show();},messageRefreshNew:function(){if($('#messagePane .status .message').length===0){$('#friends_new').hide();}else{$('#friends_new').show();}
return true;}}};
if(typeof(notifications)=="undefined"){var notifications={loaded:false,drawn:false,displayed:false,unread:0,list_unread:{},load:function(callback){if(typeof(callback)!='function'){callback=function(){};}
$('#naboo_live_loading').show();api.call('notification_get',{'start':0,'nb':20},function(request){if(request.error.length!==0){$('#notifications').html('error');return;}
if(request.results.count>0){userData.notifications=request.results.data.reverse();}else{userData.notifications=[];}
$('#naboo_live_loading').hide();if(notifications.drawn===false){notifications.createList();}
notifications.loaded=true;if(typeof(callback)=='function'){callback();}});return true;},show:function(){livebar.tab='notifications';livebar.show();friends.hide();ticker.hide();if(!notifications.loaded){notifications.load(notifications.show);return;}
$('#notifications').show();$('#btn_notifications .tabs-notif span').addClass('active');Events.trigger(Events.user.settingChange,{site:{livebar_tab:livebar.tab,livebar_state:'open'}});notifications.displayed=true;notifications.refreshNew();livebar.$livebar_content.tinyscrollbar_update('relative');Events.trigger(Events.layout.resize,{'client_width':client_width,'client_height':client_height});return true;},hide:function(){$('#notifications').hide();$('#btn_notifications .tabs-notif span').removeClass('active');notifications.displayed=false;Events.trigger(Events.layout.resize,{'client_width':client_width,'client_height':client_height});return true;},refreshNew:function(){if(notifications.unread===0){$('#notifications_new').hide();return true;}
if(notifications.unread>25){$('#notifications_new').text('25+').fadeIn();return true;}
$('#notifications_new').text(notifications.unread).fadeIn();return true;},push:function(data,content){$('#notifications').prepend(content);var $new_items=$('#notifications > div:hidden');if($new_items.length<=1){$new_items.slideDown();}else{$new_items.show();}
if(typeof(data.NOTIFICATION_ID)=='undefined'){return;}
$('#'+data.UNIQID).mouseenter(function(){hovercard.init($(this),800,true,'e',function(hovercard_div){if(hovercard_div.hasClass('unread')){var notif_data=hovercard_div.data();if(typeof(notif_data.notifid)!='undefined'){notifications.read([notif_data.notifid]);}}});}).mouseleave(function(){hovercard.remove();});if(data.READ===true||data.READ=='1'||data.READ==1){return true;}
notifications.unread+=1;notifications.refreshNew();var notif_id=parseInt(data.NOTIFICATION_ID,10);notifications.list_unread[notif_id]=data;Events.trigger(Events.live.newNotif,data);return true;},createList:function(){if(typeof(userData.notifications)=='undefined'){return false;}
notifications.drawn=true;var len=userData.notifications.length;for(var i=0;i<len;i++){var notif=userData.notifications[i];var data=notif.DATA;data.NOTIFICATION_ID=notif.NOTIFICATION_ID;data.APP='FEED';if(typeof(data.ACTION)!='undefined'){data.ACTION_OPTIONS=data.ACTION;}
data.ACTION=notif.TYPE.toUpperCase();data.DATE=notif.DATE;data.UNIQID=notif.DATE;if(typeof(notif.READ)=='undefined'){data.READ=true;}else{data.READ=notif.READ;}
if(!data.READ){notifications.unread+=1}
live.dispatch([data]);}
return true;},read:function(notif_ids){try{if(typeof(notif_ids)!='object'||typeof(notif_ids.length)=='undefined'){return false;}
var deleted_ids=[];for(var i=0;i<notif_ids.length;i++){var notif_id=parseInt(notif_ids[i],10);if(notif_id===0){continue;}
if(typeof(notifications.list_unread[notif_id])=='undefined'){continue;}
Events.trigger(Events.live.readNotif,notifications.list_unread[notif_id]);delete notifications.list_unread[notif_id];if(notifications.unread>0){notifications.unread-=1;}
notifications.refreshNew();deleted_ids.push(notif_id);}
if(deleted_ids.length>0){api.call('notification_markAsRead',{notif_ids:deleted_ids});}}catch(e){console.log(e.message,e.stack);}}}};
if(typeof(ticker)=="undefined"){var ticker={loaded:false,drawn:false,displayed:false,new_items:0,init:function(){live.addInternalChannel('-1_'+USER.USER_ID+'_USERFEED_'+USER.USER_ID);Events.subscribe(Events.live.feed,function(evt,params){ticker.draw(params);});},load:function(){$('#naboo_live_loading').show();api.call('user_getFeed',{'filter':[],'start':0,'limit':20},function(request){if(request.error.length!==0){$('#ticker').html('error');return;}
if(request.results.count>0){userData.ticker=request.results.data.reverse();}else{userData.ticker=[];}
$('#naboo_live_loading').hide();if(ticker.drawn===false){ticker.createList();}
ticker.loaded=true;ticker.show();});},show:function(){livebar.tab='ticker';livebar.show();notifications.hide();friends.hide();ticker.displayed=true;if(!ticker.loaded){ticker.load();return;}
$('#ticker').show();$('.tabs-tick span').addClass('active');Events.trigger(Events.user.settingChange,{site:{livebar_tab:livebar.tab,livebar_state:'open'}});ticker.new_items=0;ticker.refreshNew();livebar.$livebar_content.tinyscrollbar_update('relative');return true;},hide:function(){$('#ticker').hide();$('.tabs-tick span').removeClass('active');ticker.displayed=false;return true;},refreshNew:function(){if(ticker.new_items===0){$('#ticker_new').fadeOut();return true;}
if(ticker.new_items>25){$('#ticker_new').text('25+').fadeIn();return true;}
$('#ticker_new').text(ticker.new_items).fadeIn();return true;},createList:function(){try{if(typeof(userData.ticker)=='undefined'){return false;}
ticker.drawn=true;var len=userData.ticker.length;for(var i=0;i<len;i++){var data=userData.ticker[i];live.dispatch([data]);}
return true;}catch(e){console.log(e);}},draw:function(message){try{if(typeof(message)=='undefined'||message===''){return false;}
var data=message[0];var time=message[1];if((live.server_timestamp-time)>5){return;}
var push_type='ticker';if(typeof(data.UNIQID)=='undefined'){data.UNIQID=new Date().getTime();}
$new_ticker=livebar.$ticker_modele.clone();$new_ticker.attr('id',data.UNIQID);$new_ticker.attr('data-notifid',data.NOTIFICATION_ID);if(typeof(data.USER_PICTURE)!='undefined'){$('img',$new_ticker).attr({'src':(SETTING_DOMAIN_IMG+'/user/'+data.USER_PICTURE+'/30x30-000000-80-0-0.jpg')});}
switch(data.ACTION){case'RADIO_COMMENT':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=comment&type=radio&id='+data.RADIO_ID+'&user_id='+data.USER_ID+'&comment_id='+data.COMMENT_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_radio_comment_1,ucfirst(data.DISPLAY_NAME),data.RADIO_TITLE));break;case'ARTIST_COMMENT':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=comment&type=artist&id='+data.ART_ID+'&user_id='+data.USER_ID+'&comment_id='+data.COMMENT_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_artist_comment_1,ucfirst(data.DISPLAY_NAME),data.ART_NAME));break;case'ALBUM_COMMENT':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=comment&type=album&id='+data.ALB_ID+'&user_id='+data.USER_ID+'&comment_id='+data.COMMENT_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_album_comment_1,ucfirst(data.DISPLAY_NAME),data.ALB_TITLE,data.ART_NAME));break;case'PLAYLIST_COMMENT':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=comment&type=playlist&id='+data.PLAYLIST_ID+'&user_id='+data.USER_ID+'&comment_id='+data.COMMENT_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_playlist_comment_1,ucfirst(data.USER_NAME),data.PLAYLIST_TITLE));push_type='notification';break;case'RADIO_FAN':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=fan&type=radio&id='+data.RADIO_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_radio_fan_1,ucfirst(data.DISPLAY_NAME),data.RADIO_TITLE));break;case'ARTIST_FAN':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=fan&type=artist&id='+data.ART_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_artist_fan_1,ucfirst(data.DISPLAY_NAME),data.ART_NAME));break;case'ALBUM_FAN':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=fan&type=album&id='+data.ALB_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_album_fan_1,ucfirst(data.DISPLAY_NAME),data.ALB_TITLE,data.ART_NAME));break;case'PLAYLIST_FAN':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=fan&type=playlist&id='+data.PLAYLIST_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_playlist_fan_1,ucfirst(data.DISPLAY_NAME),data.PLAYLIST_TITLE));break;case'PLAYLIST_CREATION':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=creation&type=playlist&id='+data.PLAYLIST_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_playlist_creation_1,ucfirst(data.DISPLAY_NAME),data.PLAYLIST_TITLE));break;case'TRACK_PLAY':if(typeof(userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]])!="undefined"){if(ENV=='DEV'){console.log(userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]]);}
var prevOffline;if(userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].TIMER===0){prevOffline=true;}
userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].TIMER=900;if(typeof(data.SNG_ID)!=='undefined'&&typeof(data.ART_NAME)!='undefined'&&typeof(data.SNG_TITLE)!='undefined'){userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].SONG={};userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].SONG.SNG_ID=data.SNG_ID;userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].SONG.ART_NAME=data.ART_NAME;userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].SONG.SNG_TITLE=data.SNG_TITLE;}else{userData.data.FRIENDS.data[userData.data.FRIENDS_HASH[data.USER_ID]].SONG=false;}
if(prevOffline===true){live.online_count+=1;}
if(friends.drawn===true){friends.changeState(data.USER_ID,"online");}}
hovercard_link='/ajax/hovercard/page.php?card=ticker&action=listen&type=song&id='+data.SNG_ID+'&user_id='+data.USER_ID;if(typeof(data.CONTEXT)!='undefined'&&typeof(data.CONTEXT.ID)!='undefined'&&typeof(data.CONTEXT.TYPE)!='undefined'){hovercard_link+='&context_id='+data.CONTEXT.ID+'&context_type='+data.CONTEXT.TYPE;}
$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_listen,ucfirst(data.DISPLAY_NAME),data.SNG_TITLE,data.ART_NAME));var past_tense=sprintf(trad.live.text_live_feed_listened,ucfirst(data.DISPLAY_NAME),data.SNG_TITLE,data.ART_NAME);var past_tense_id=data.UNIQID;var past_tense_duration=180;if(typeof(data.DURATION)!='undefined'){past_tense_duration=data.DURATION-30;}
setTimeout(function(){ticker.updateTense(past_tense_id,past_tense);},(past_tense_duration*1000));break;case'NEW_MESSAGE':if($('#facebox #messenger').length==1){Events.trigger(Events.live.newMessage,data);}else{friends.changeState(data.USER_ID,"message");}
return false;case'FRIEND_FOLLOW':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=friend_accept&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_share_friend_follow,ucfirst(data.USER_NAME)));$('img',$new_ticker).attr({'src':(SETTING_DOMAIN_IMG+'/user/'+data.USER_PICTURE+'/30x30-000000-80-0-0.jpg')});push_type='notification';break;case'PLAYLIST_COMMENT':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=comment&type=playlist&id='+data.USER_ID+'&comment_id='+data.COMMENT_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_playlist_comment,ucfirst(data.USER_NAME),ucfirst(data.PLAYLIST_TITLE)));push_type='notification';break;case'PLAYLIST_FOLLOW':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=playlist_follow&type=playlist&id='+data.PLAYLIST_ID+'&user_id='+data.USER_ID;$('span',$new_ticker).html(sprintf(trad.live.text_live_feed_playlist_follow,ucfirst(data.USER_NAME),ucfirst(data.PLAYLIST_TITLE)));push_type='notification';break;case'APPLICATION_NOTIFICATION':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=application_notification&type=application&id='+data.APP_ID+'&action_uri='+encodeURIComponent(data.ACTION_OPTIONS.URI)+(data.ACTION_OPTIONS.LABEL===null?'':('&action_label='+encodeURIComponent(data.ACTION_OPTIONS.LABEL)))+'&message='+encodeURIComponent(data.MESSAGE);$('span',$new_ticker).text(data.MESSAGE);$('img',$new_ticker).attr({'src':(SETTING_DOMAIN_IMG+'/misc/'+data.APP_PICTURE+'/30x30-000000-80-0-0.jpg')});push_type='notification';break;case'APPLICATION_REQUEST':hovercard_link='/ajax/hovercard/page.php?card=ticker&action=application_request&type=application&id='+data.APP_ID+'&user_id='+data.USER_ID+'&message='+encodeURIComponent(data.CUSTOM_MESSAGE);$('span',$new_ticker).html(sprintf(trad.live.text_live_app_request,ucfirst(data.USER_NAME),ucfirst(data.APP_NAME)));push_type='notification';break;case'SHARE':var message;var id;switch(data.TYPE){case"RADIO":message=sprintf(trad.live.text_live_feed_share_radio,ucfirst(data.USER_NAME),data.TITLE);id=data.RADIO_ID;break;case"SONG":message=sprintf(trad.live.text_live_feed_share_song,ucfirst(data.USER_NAME),data.SNG_TITLE,data.ART_NAME);id=data.SNG_ID;break;case"ALBUM":message=sprintf(trad.live.text_live_feed_share_album,ucfirst(data.USER_NAME),data.ALB_TITLE,data.ART_NAME);id=data.ALB_ID;break;case"ARTIST":message=sprintf(trad.live.text_live_feed_share_artist,ucfirst(data.USER_NAME),data.ART_NAME);id=data.ART_ID;break;case"PLAYLIST":message=sprintf(trad.live.text_live_feed_share_playlist,ucfirst(data.USER_NAME),data.TITLE);id=data.PLAYLIST_ID;break;case"SMART_RADIO":message=sprintf(trad.live.text_live_feed_share_radio,ucfirst(data.USER_NAME),data.ART_NAME);id=data.ART_ID;break;default:return;}
$('span',$new_ticker).html(message);hovercard_link='/ajax/hovercard/page.php?card=ticker&action=share&type='+data.TYPE.toLowerCase()+'&id='+id+'&user_id='+data.USER_ID;push_type='notification';break;default:return;}
if(typeof(data.VIA)!='undefined'){$('span',$new_ticker).append('<br>A partir de <a href="" onClick="">'+data.VIA.APP_NAME+'</a>');}
if(typeof(hovercard_link)!='undefined'&&hovercard_link!==''){hovercard_link+="&notif_id="+data.NOTIFICATION_ID;if(typeof(data.READ)=='undefined'||(data.READ===false||data.READ=='0'||data.READ===0)){hovercard_link+="&notif_unread=true";}
if(typeof(data.DATE)!='undefined'){hovercard_link+='&timestamp='+data.DATE;}
$new_ticker.attr('data-hovercard',hovercard_link);}
if(push_type=='notification'){if(typeof(data.READ)=='undefined'||(data.READ===false||data.READ=='0'||data.READ==0)){$new_ticker.addClass('unread');}}
if(push_type=='ticker'){if(!ticker.displayed){ticker.new_items+=1;ticker.refreshNew();}
ticker.loaded_nb+=1;ticker.push(data.UNIQID,$new_ticker);}
if(push_type=='notification'){notifications.push(data,$new_ticker);}
return true;}catch(e){console.log(e.message,e.stack);}},push:function(id,content){$('#ticker').prepend(content);var $new_items=$('#ticker > div:hidden');if($new_items.length<=1){$new_items.slideDown();}else{$new_items.show();}
$('#'+id).mouseenter(function(){hovercard.init($(this),800,true,'e');}).mouseleave(function(){hovercard.remove();});return true;},updateTense:function(id,past_tense){$('#'+id+' span').html(past_tense);return true;}}};
if(typeof(livebar)=="undefined"){var livebar={displayed:false,state:'open',tab:'',init:function(){livebar.$livebar=$("#livebar");livebar.$livemenu=$("#livemenu");livebar.$livebar_menu=$("#livebar_menu");livebar.$livebar_content=$("#livebar_content");livebar.$ticker_modele=$("#ticker_modele");livebar.$modele_friend=$('#online_friend_default');$('#btn_friends').tipsy({gravity:'s',force_top:true});$('#btn_ticker').tipsy({gravity:'s',force_top:true});$('#btn_notifications').tipsy({gravity:'s',force_top:true});$('#minimize').tipsy({gravity:'s',force_top:true});livebar.$livebar_content.bind('jsp-scrolling',function(event,pos){if(friends.displayed){if(pos>friends.lastScrollPosition){friends.lazyLoad(friends.lastScrollPosition,pos);friends.lastScrollPosition=pos;}}}).tinyscrollbar();Events.ready(Events.user.loaded,function(){if(OFFLINE){return;}
livebar.$livebar_menu.show();livebar.state='open';if(typeof(USER.SETTING.site.livebar_state)!='undefined'){livebar.state=USER.SETTING.site.livebar_state;}
if(livebar.state=='open'){livebar.show();}
ticker.init();limitation.init();});Events.ready(Events.user.userReady,livebar.initUser);Events.addEvent('livebar',Events.layout.width_type,function(evt,params){if(USER.USER_ID===0){return;}
livebar.resize(params);});Events.addEvent('livebar',Events.layout.resize,function(){if(livebar.state=='open'&&(friends.loaded||ticker.loaded||notifications.loaded)){livebar.$livebar_content.tinyscrollbar_update('relative');}
livebar.updateScrollHeight();});Events.subscribe(Events.live.readNotif,function(evt,data){if(typeof(data.UNIQID)=='undefined'){return false;}
var notif=$("#"+data.UNIQID);if(notif.length==0){return false;}
if(notif.hasClass('unread')){notif.removeClass('unread');}
return true;});livebar.$livebar_content.mouseleave(function(){if(livebar.layout=='small'&&typeof($('.tipsy.tipsy-ontop.tipsy-s').attr('class'))==='undefined'){livebar.hide();}});},initUser:function(){try{$('#naboo_live_loading').hide();friends.loaded=false;friends.drawn=false;livebar.prepareData();www.layoutDetectSize();var onNotificationLoaded=function(){Events.resolve(Events.live.ready);};if(livebar.state=='open'){if(typeof(USER.SETTING)!='undefined'){livebar.tab=USER.SETTING.site.livebar_tab;}
switch(livebar.tab){case'friends':friends.show();notifications.load();break;case'ticker':ticker.show();notifications.load();break;case'notifications':notifications.show();break;default:ticker.show();notifications.load();}}else{notifications.load();}
return true;}catch(e){console.log(e.message,e.stack);}},prepareData:function(){if(typeof(userData.data.FRIENDS)=='undefined'){return false;}
live.online_count=0;var len=userData.data.FRIENDS.count;for(var i=0;i<len;i++){if(userData.data.FRIENDS.data[i]!=null){if(typeof(userData.data.FRIENDS.data[i].TIMER)!='undefined'){continue;}
if(userData.data.FRIENDS.data[i].ONLINE===false){userData.data.FRIENDS.data[i].TIMER=0;userData.data.FRIENDS.data[i].SONG=false;}else{userData.data.FRIENDS.data[i].TIMER=900;if(userData.data.FRIENDS.data[i].ONLINE.SONG==null){userData.data.FRIENDS.data[i].SONG=false;}else{userData.data.FRIENDS.data[i].SONG=userData.data.FRIENDS.data[i].ONLINE.SONG;}
live.online_count+=1;}
if(typeof(userData.data.MESSAGE_UNREAD)!='undefined'&&typeof(userData.data.MESSAGE_UNREAD_HASH[userData.data.FRIENDS.data[i].USER_ID])!='undefined'){$('#friends_new').show();}}
delete userData.data.FRIENDS.data[i].ONLINE;}
return true;},show:function(){if(livebar.displayed){return true;}
$('#minimize').show();$('#naboo_livebar').show();$('#livebar_overflow').show();livebar.$livemenu.addClass('opened');livebar.$livebar_content.show();if(USER.FB_USER_ID===0){$('.no_friends',livebar.$livebar_content).show();}
livebar.state='open';livebar.displayed=true;livebar.updateScrollHeight();return true;},hide:function(){if(!livebar.displayed){return true;}
$('#minimize').hide();$('#naboo_livebar').hide();$('#livebar_overflow').hide();friends.hide();ticker.hide();notifications.hide();livebar.$livemenu.removeClass('opened');livebar.state='close';livebar.displayed=false;Events.trigger(Events.user.settingChange,{site:{livebar_state:'close'}});return true;},updateScrollHeight:function(){if(livebar.state=='close'){return false;}
var h=client_height-105;if(livebar.layout=='small'){h=460;}
if(USER.FB_USER_ID===0){h-=168;}
if(livebar.tab=='friends'){h-=45;}
h-=30;livebar.scrollHeight=h;$('#livebar_overflow',livebar.$livebar_content).css('height',h+'px');livebar.$livebar_content.tinyscrollbar_update('relative');return true;},resize:function(size){try{livebar.layout=size;livebar.$livebar_content.tinyscrollbar_update('relative');return true;}catch(e){console.log(e.message,e.stack);}},destroy:function(){try{live.disconnect();limitation.reset();Events.unsubscribeAll('livebar');friends.drawn=false;ticker.drawn=false;notifications.drawn=false;friends.loaded=false;ticker.loaded=false;notifications.loaded=false;$('#ticker',livebar.$livebar_content).empty();$('#notifications',livebar.$livebar_content).empty();$('#onlinePane',livebar.$livebar_content).empty();$('#offlinePane',livebar.$livebar_content).empty();return true;}catch(e){console.log(e.message,e.stack);}}}};
if(typeof(xhr_polling)=='undefined'){var xhr_polling={retry:0,proxy_loaded:false,gateway:null,last_subscribe:0,subscribre_interval:5,init:function(){try{xhr_polling.loadProxy();}catch(e){console.log(e);}},loadProxy:function(){if(xhr_polling.proxy_loaded){return true;}
$('#livebar_gateway').html('<iframe id="livebarGatewayJS" src="'+PROTOCOL_HTTP+SETTING_HOST_LIVE+'/proxy.html"></iframe>');xhr_polling.gateway=document.getElementById('livebarGatewayJS');return true;},proxyLoaded:function(){console.log('xhr_polling: connected');live.connected=true;live.transport='xhr';xhr_polling.proxy_loaded=true;xhr_polling.subscribe();return true;},close:function(){console.log('xhr_polling: closed');$('#livebar_gateway').empty();live.connected=false;xhr_polling.proxy_loaded=false;xhr_polling.gateway=null;return true;},proxyTimeout:function(){try{if(xhr_polling.gateway===null){return;}
if(xhr_polling.timeoutID!==null){window.clearTimeout(live.timeoutID);}
var diff=new Date().getTime()-xhr_polling.last_subscribe;if(diff<(xhr_polling.subscribre_interval*1000)){xhr_polling.timeoutID=window.setTimeout(function(){xhr_polling.subscribe();},5000);return;}
xhr_polling.subscribe();return;}catch(e){console.log(e);}},subscribe:function(){try{if(xhr_polling.gateway===null){return;}
if(USER.USER_ID===0){return false;}
if(countObject(live.channels)===0){return false;}
var channels={};channels.channels=[];var count=0;for(var channel in live.channels){channels.channels[count]={chanKey:channel};count+=1;}
xhr_polling.status='pending';xhr_polling.gateway.contentWindow.cmdRecv('/recv/'+getCookie('sid'),JSON.stringify(channels));xhr_polling.last_subscribe=new Date().getTime();return true;}catch(e){console.log(e.message,e.stack);}},publish:function(channel,data){try{if(xhr_polling.gateway===null){return;}
var message={};message.chanKey=channel;message.data=JSON.stringify(data);xhr_polling.gateway.contentWindow.cmdSend('/send/'+getCookie('sid'),JSON.stringify(message));return true;}catch(e){console.log(e);}},onMsg:function(data){try{if(typeof(data)=='undefined'||data.length<=0){return false;}
data=JSON.parse(data);if(typeof(data.results)=='undefined'){return false;}
if(data.results=='OK'){return false;}
live.server_timestamp=data.context.TIMESTAMP;data=data.results;for(var i in data){var a=data[i].split(':');var time=a[2];var msg=JSON.parse(base64_decode(a[3]));live.dispatch([msg,time]);}
live.subscribe();return true;}catch(e){console.log(e);}}};};